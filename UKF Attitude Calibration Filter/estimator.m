% alignment filter
%%%%%%%%%%%%%%%%%%
[qe,we,be,ge,s1e,P_cov]=ekf(dts,tf,y);     % Extended Kalman Filter
%[qe,we,be,ge,s1e,P_cov]=uf(dts,tf,y);       % Unscented Filter

figure(10)
plot(ts,qe)
title('Estimated Quaternions')
xlabel('Time, hr')

figure(11)
subplot(311)
plot(ts,we(1,:))
ylabel('Gyro 1, rad/s')
title('Estimated Rotational Rate')
subplot(312)
plot(ts,we(2,:))
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,we(3,:))
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

% just to make the plots nicer
be(:,1)=be(:,5); be(:,2)=be(:,5); be(:,3)=be(:,5); be(:,4)=be(:,5); 

figure(12)
subplot(311)
plot(ts,be(1,:))
axis([0 tf/3600 0e-6 2e-6])
%axis([0 tf/3600 9.5e-7 10e-7])
title('Estimated Gyro Bias')
ylabel('Gyro 1, rad/s')
subplot(312)
plot(ts,be(2,:))
axis([0 tf/3600 .5e-6 2.5e-6])
%axis([0 tf/3600 1.45e-6 1.50e-6])
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,be(3,:))
axis([0 tf/3600 0e-6 2e-6])
%axis([0 tf/3600 9.5e-7 10e-7])
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

figure(13)
plot(ts,ge(4:6,:)*1e6)
axis([0 tf/3600 0 1000])
title('Estimated gyro symmetric scale factor')
ylabel('ppm')
xlabel('Time, hr')
legend('\lambda_{x}','\lambda_{y}','\lambda_{z}')

figure(14)
plot(ts,ge(7:9,:)*1e6)
%axis([0 tf/3600 0 1000])
title('Estimated gyro asymmetric scale factor')
ylabel('ppm')
xlabel('Time, hr')
legend('\mu_{x}','\mu_{y}','\mu_{z}')

figure(15)
plot(ts,ge(1:3,:)*206264.8)
axis([0 tf/3600 -600 600])
title('Estimated gyro nonorthogonal misalignment, arc-s')
xlabel('Time, hr')
legend('\xi_{x}','\xi_{y}','\xi_{z}')

figure(16)
plot(ts,s1e*206264.8)
axis([0 tf/3600 -30 30])
title('Estimated Star Tracker 1 Misalignment')
ylabel('arc-s')
xlabel('Time, hr')

% just to make the plots look nicer
P_cov(1:3,1)=P_cov(1:3,12); P_cov(1:3,2)=P_cov(1:3,12); P_cov(1:3,3)=P_cov(1:3,12); P_cov(1:3,4)=P_cov(1:3,12); P_cov(1:3,5)=P_cov(1:3,12); P_cov(1:3,6)=P_cov(1:3,12); 
P_cov(1:3,7)=P_cov(1:3,12); P_cov(1:3,8)=P_cov(1:3,12); P_cov(1:3,9)=P_cov(1:3,12); P_cov(1:3,10)=P_cov(1:3,12); P_cov(1:3,11)=P_cov(1:3,12); 

figure(17)
subplot(211)
plot(ts,2*3*sqrt(P_cov(1:3,:)))
title('Attitude error covariance(deg) - 3\sigma')
subplot(212)
plot(ts,3*sqrt(P_cov(4:6,:)))
title('Gyro Bias error covariance(rad/s) - 3\sigma')
xlabel('Time, hr')

%b(:,tf/dt)
%be(:,tf/dts)

% find error of estimated values
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
[q_diff,w_diff,b_diff,g_diff,s1_diff]=err(dts,tf,q,qe,w,we,b,be,ge,s1e);

figure(21)
subplot(311)
plot(ts,2*q_diff(1,:), ts,-3*2*sqrt(P_cov(1,:)), ts,3*2*sqrt(P_cov(1,:)))
axis([0 tf/3600 -.5e-4 .5e-4])
title('Quaternion Error with 3\sigma bound')
ylabel('Roll, deg')
subplot(312)
plot(ts,2*q_diff(2,:), ts,-3*2*sqrt(P_cov(2,:)), ts,3*2*sqrt(P_cov(2,:)))
axis([0 tf/3600 -.5e-4 .5e-4])
ylabel('Pitch, deg')
subplot(313)
plot(ts,2*q_diff(3,:), ts,-3*2*sqrt(P_cov(3,:)), ts,3*2*sqrt(P_cov(3,:)))
axis([0 tf/3600 -.5e-4 .5e-4])
ylabel('Yaw, deg')
xlabel('Time, hr')

figure(22)
subplot(311)
plot(ts,w_diff(1,:))
title('Rotational Rate Error')
ylabel('Gyro 1, rad/s')
subplot(312)
plot(ts,w_diff(2,:))
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,w_diff(3,:))
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

figure(23)
subplot(311)
plot(ts,b_diff(1,:), ts,-3*sqrt(P_cov(4,:)), ts,3*sqrt(P_cov(4,:)))
axis([0 tf/3600 -.1e-5 .1e-5])
title('Gyro Bias Error with 3\sigma bound')
ylabel('Gyro 1, rad/s')
subplot(312)
plot(ts,b_diff(2,:), ts,-3*sqrt(P_cov(5,:)), ts,3*sqrt(P_cov(5,:)))
axis([0 tf/3600 -.1e-5 .1e-5])
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,b_diff(3,:), ts,-3*sqrt(P_cov(6,:)), ts,3*sqrt(P_cov(6,:)))
axis([0 tf/3600 -.1e-5 .1e-5])
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

figure(24)
subplot(311)
plot(ts,g_diff(4,:)*1e6, ts,-3*sqrt(P_cov(10,:))*1e6, ts,3*sqrt(P_cov(10,:))*1e6)
axis([0 tf/3600 -300 300])
title('Gyro Symmetric Scale Factor Error with 3\sigma bound')
ylabel('\lambda_{x}, ppm')
subplot(312)
plot(ts,g_diff(5,:)*1e6, ts,-3*sqrt(P_cov(11,:))*1e6, ts,3*sqrt(P_cov(11,:))*1e6)
axis([0 tf/3600 -300 300])
ylabel('\lambda_{y}, ppm')
subplot(313)
plot(ts,g_diff(6,:)*1e6, ts,-3*sqrt(P_cov(12,:))*1e6, ts,3*sqrt(P_cov(12,:))*1e6)
axis([0 tf/3600 -300 300])
ylabel('\lambda_{z}, ppm')
xlabel('Time, hr')

figure(25)
subplot(311)
plot(ts,g_diff(7,:)*1e6, ts,-3*sqrt(P_cov(13,:))*1e6, ts,3*sqrt(P_cov(13,:))*1e6)
axis([0 tf/3600 -300 300])
title('Gyro Asymmetric Scale Factor Error with 3\sigma bound')
ylabel('\mu_{x}, ppm')
subplot(312)
plot(ts,g_diff(8,:)*1e6, ts,-3*sqrt(P_cov(14,:))*1e6, ts,3*sqrt(P_cov(14,:))*1e6)
axis([0 tf/3600 -300 300])
ylabel('\mu_{y}, ppm')
subplot(313)
plot(ts,g_diff(9,:)*1e6, ts,-3*sqrt(P_cov(15,:))*1e6, ts,3*sqrt(P_cov(15,:))*1e6)
axis([0 tf/3600 -300 300])
ylabel('\mu_{z}, ppm')
xlabel('Time, hr')

figure(26)
subplot(311)
plot(ts,g_diff(1,:)*206264.8, ts,-3*sqrt(P_cov(7,:))*206264.8, ts,3*sqrt(P_cov(7,:))*206264.8)
axis([0 tf/3600 -300 300])
ylabel('\xi_{x}, arc-s')
title('Gyro Nonorthogonal Misalignments Error with 3\sigma bound')
subplot(312)
plot(ts,g_diff(2,:)*206264.8, ts,-3*sqrt(P_cov(8,:))*206264.8, ts,3*sqrt(P_cov(8,:))*206264.8)
axis([0 tf/3600 -300 300])
ylabel('\xi_{y}, arc-s')
subplot(313)
plot(ts,g_diff(3,:)*206264.8, ts,-3*sqrt(P_cov(9,:))*206264.8, ts,3*sqrt(P_cov(9,:))*206264.8)
axis([0 tf/3600 -300 300])
ylabel('\xi_{z}, arc-s')

figure(27)
subplot(311)
plot(ts,s1_diff(1,:)*60^2, ts,-3*sqrt(P_cov(16,:))*60^2, ts,3*sqrt(P_cov(16,:))*60^2)
axis([0 tf/3600 -.20 .20])
title('Star Tracker Misalignments Error with 3\sigma bound')
ylabel('x, arc-s')
subplot(312)
plot(ts,s1_diff(2,:)*60^2, ts,-3*sqrt(P_cov(17,:))*60^2, ts,3*sqrt(P_cov(17,:))*60^2)
axis([0 tf/3600 -.20 .20])
ylabel('y, arc-s')
subplot(313)
plot(ts,s1_diff(3,:)*60^2, ts,-3*sqrt(P_cov(18,:))*60^2, ts,3*sqrt(P_cov(18,:))*60^2)
axis([0 tf/3600 -.20 .20])
ylabel('z, arc-s')
xlabel('Time, hr')



