clear all
close all

% constants
dt  = .5 ;         % truth propagation interval
dts = 2*dt ;        % sampling interval
tf  = 6*60*60 ;       % final time
t   = [0:dt:tf-dt] ;
ts  = [0:dts:tf-dt] ;

load map_20010701_msradj_1519_2124.mat irua1_adj_eng
w   = [ 0.09*pi/180*sin(0.006*2*pi/10*t+0)             % the best one
        0.09*pi/180*sin(0.007*2*pi/10*t+pi/2)
        0.09*pi/180*sin(0.008*2*pi/10*t+pi/8)  ] ;

time_iru     = irua1_adj_eng(:,1)-irua1_adj_eng(1,1);
w            = interp1(time_iru(:,1),irua1_adj_eng(:,2:4),t','spline')';

t  = t/3600;
ts = ts/3600;

figure(100)
subplot(311)
plot(time_iru/3600,irua1_adj_eng(:,2))
subplot(312)
plot(time_iru/3600,irua1_adj_eng(:,3))
subplot(313)
plot(time_iru/3600,irua1_adj_eng(:,4))

figure(101)
subplot(311)
plot(t,w(1,:))
subplot(312)
plot(t,w(2,:))
subplot(313)
plot(t,w(3,:))

% truth and measurement
%%%%%%%%%%%%%%%%%%%%%%%
[q,y,q_norm,wd,b]=truth(dt,dts,tf,w);

% plotting
figure(1)
plot(t,q)
title('Truth Quaternions')

figure(2)
plot(t,q_norm)
title('Quaternion Normalization Constraint Checking')

figure(3)
subplot(311)
plot(t,w(1,:))
title('True Rotational Rate')
ylabel('Gyro 1 True, rad/s')
subplot(312)
plot(t,w(2,:))
ylabel('Gyro 2 True, rad/s')
subplot(313)
plot(t,w(3,:))
ylabel('Gyro 3 True, rad/s')
xlabel('Time, hr')

figure(4)
subplot(311)
plot(ts,y(1,:))
title('Gyro Measured Rotational Rate')
ylabel('Gyro 1 mea, rad/s')
subplot(312)
plot(ts,y(2,:))
ylabel('Gyro 2 mea, rad/s')
subplot(313)
plot(ts,y(3,:))
ylabel('Gyro 3 mea, rad/s')
xlabel('Time, hr')

figure(5)
subplot(311)
plot(ts,wd(1,:))
title('Rotational Rate Measurement Residual')
ylabel('Gyro 1 diff, rad/s')
subplot(312)
plot(ts,wd(2,:))
ylabel('Gyro 2 diff, rad/s')
subplot(313)
plot(ts,wd(3,:))
ylabel('Gyro 3 diff, rad/s')
xlabel('Time, hr')

figure(6)
subplot(311)
plot(t,b(1,:))
axis([0 tf/3600 -2e-6 4e-6])
%axis([0 tf/3600 9.5e-7 10e-7])
title('Gyro Drift')
ylabel('Gyro 1 drift, rad/s')
subplot(312)
plot(t,b(2,:))
axis([0 tf/3600 -1.5e-6 4.5e-6])
%axis([0 tf/3600 1.45e-6 1.50e-6])
ylabel('Gyro 2 drift, rad/s')
subplot(313)
plot(t,b(3,:))
axis([0 tf/3600 -2e-6 4e-6])
%axis([0 tf/3600 9.5e-7 10e-7])
ylabel('Gyro 3 drift, rad/s')
xlabel('Time, hr')

%clear b q_norm wd

% alignment filter
%%%%%%%%%%%%%%%%%%
%[qe,we,be,ge,s1e,P_cov]=ekf(dts,tf,y);     % Extended Kalman Filter
[qe,we,be,ge,s1e,pe,P_cov]=uf(dts,tf,y);       % Unscented Filter

figure(10)
plot(ts,qe)
title('Estimated Quaternions')
xlabel('Time, hr')

figure(11)
subplot(311)
plot(ts,we(1,:))
ylabel('Gyro 1, rad/s')
title('Estimated Rotational Rate')
subplot(312)
plot(ts,we(2,:))
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,we(3,:))
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

% just to make the plots nicer
be(:,1)=be(:,5); be(:,2)=be(:,5); be(:,3)=be(:,5); be(:,4)=be(:,5); 

figure(12)
subplot(311)
plot(ts,be(1,:))
%axis([0 tf/3600 0e-6 2e-6])
title('Estimated Gyro Bias')
ylabel('Gyro 1, rad/s')
subplot(312)
plot(ts,be(2,:))
%axis([0 tf/3600 .5e-6 2.5e-6])
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,be(3,:))
%axis([0 tf/3600 0e-6 2e-6])
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

figure(13)
plot(ts,ge(4,:)*1e6,'-', ts,ge(5,:)*1e6,':', ts,ge(6,:)*1e6,'-.')
axis([0 tf/3600 -250 250])
title('Estimated Gyro Symmetric Scale Factor Error')
ylabel('ppm')
xlabel('Time, hr')
legend('\lambda_{x}','\lambda_{y}','\lambda_{z}')

%figure(14)
%plot(ts,ge(7:9,:)*1e6)
%axis([0 tf/3600 0 1000])
%title('Estimated Gyro Asymmetric Scale Factor')
%ylabel('ppm')
%xlabel('Time, hr')
%legend('\mu_{x}','\mu_{y}','\mu_{z}')

figure(15)
plot(ts,ge(1,:)*206264.8,'-', ts,ge(2,:)*206264.8,':', ts,ge(3,:)*206264.8,'-.')
axis([0 tf/3600 -300 300])
title('Estimated Gyro Nonorthogonal Misalignment')
xlabel('Time, hr')
ylabel('arc-s')
legend('\xi_{x}','\xi_{y}','\xi_{z}')

figure(16)
plot(ts,s1e*206264.8)
axis([0 tf/3600 -30 30])
title('Estimated Star Tracker Misalignment')
ylabel('arc-s')
xlabel('Time, hr')

figure(17)
plot(ts,pe*206264.8)
axis([0 tf/3600 -30 30])
title('Estimated Payload Misalignment')
ylabel('arc-s')
xlabel('Time, hr')

% just to make the plots look nicer
P_cov(1:3,1)=P_cov(1:3,12); P_cov(1:3,2)=P_cov(1:3,12); P_cov(1:3,3)=P_cov(1:3,12); P_cov(1:3,4)=P_cov(1:3,12); P_cov(1:3,5)=P_cov(1:3,12); P_cov(1:3,6)=P_cov(1:3,12); 
P_cov(1:3,7)=P_cov(1:3,12); P_cov(1:3,8)=P_cov(1:3,12); P_cov(1:3,9)=P_cov(1:3,12); P_cov(1:3,10)=P_cov(1:3,12); P_cov(1:3,11)=P_cov(1:3,12); 

figure(18)
subplot(211)
plot(ts,2*3*sqrt(P_cov(1,:)),'-', ts,2*3*sqrt(P_cov(2,:)),':', ts,2*3*sqrt(P_cov(3,:)),'-.')
title('Attitude error covariance(deg) with 3\sigma bound')
legend('x','y','z')
subplot(212)
plot(ts,3*sqrt(P_cov(4,:)),'-', ts,3*sqrt(P_cov(5,:)),':', ts,3*sqrt(P_cov(6,:)),'-.')
axis([0 tf/3600 0 1E-6])
title('Gyro Bias error covariance(rad/s) with 3\sigma bound')
xlabel('Time, hr')
legend('x','y','z')

%b(:,tf/dt)
%be(:,tf/dts)

% find error of estimated values
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
[q_diff,w_diff,b_diff,g_diff,s1_diff,p_diff]=err(dts,tf,q,qe,w,we,b,be,ge,s1e,pe);

figure(21)
subplot(311)
plot(ts,2*q_diff(1,:), ts,-3*2*sqrt(P_cov(1,:)), ts,3*2*sqrt(P_cov(1,:)))
%plot(ts,3*2*sqrt(P_cov(1,:)))
axis([0 tf/3600 -.5e-3 .5e-3])
title('Quaternion Error with 3\sigma bound')
ylabel('Roll, deg')
subplot(312)
plot(ts,2*q_diff(2,:), ts,-3*2*sqrt(P_cov(2,:)), ts,3*2*sqrt(P_cov(2,:)))
%plot(ts,3*2*sqrt(P_cov(2,:)))
axis([0 tf/3600 -.5e-3 .5e-3])
ylabel('Pitch, deg')
subplot(313)
plot(ts,2*q_diff(3,:), ts,-3*2*sqrt(P_cov(3,:)), ts,3*2*sqrt(P_cov(3,:)))
%plot(ts,3*2*sqrt(P_cov(3,:)))
axis([0 tf/3600 -.5e-3 .5e-3])
ylabel('Yaw, deg')
xlabel('Time, hr')

figure(22)
subplot(311)
plot(ts,w_diff(1,:))
title('Rotational Rate Error')
ylabel('Gyro 1, rad/s')
subplot(312)
plot(ts,w_diff(2,:))
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,w_diff(3,:))
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

figure(23)
subplot(311)
plot(ts,b_diff(1,:), ts,-3*sqrt(P_cov(4,:)), ts,3*sqrt(P_cov(4,:)))
%plot(ts,3*sqrt(P_cov(4,:)))
axis([0 tf/3600 -.1e-5 .1e-5])
title('Gyro Bias Error with 3\sigma bound')
ylabel('Gyro 1, rad/s')
subplot(312)
plot(ts,b_diff(2,:), ts,-3*sqrt(P_cov(5,:)), ts,3*sqrt(P_cov(5,:)))
%plot(ts,3*sqrt(P_cov(5,:)))
axis([0 tf/3600 -.1e-5 .1e-5])
ylabel('Gyro 2, rad/s')
subplot(313)
plot(ts,b_diff(3,:), ts,-3*sqrt(P_cov(6,:)), ts,3*sqrt(P_cov(6,:)))
%plot(ts,3*sqrt(P_cov(6,:)))
axis([0 tf/3600 -.1e-5 .1e-5])
ylabel('Gyro 3, rad/s')
xlabel('Time, hr')

figure(24)
subplot(311)
plot(ts,g_diff(4,:)*1e6, ts,-3*sqrt(P_cov(10,:))*1e6, ts,3*sqrt(P_cov(10,:))*1e6)
%plot(ts,3*sqrt(P_cov(10,:))*1e6)
axis([0 tf/3600 -300 300])
title('Gyro Symmetric Scale Factor Error with 3\sigma bound')
ylabel('\lambda_{x}, ppm')
subplot(312)
plot(ts,g_diff(5,:)*1e6, ts,-3*sqrt(P_cov(11,:))*1e6, ts,3*sqrt(P_cov(11,:))*1e6)
%plot(ts,3*sqrt(P_cov(11,:))*1e6)
axis([0 tf/3600 -300 300])
ylabel('\lambda_{y}, ppm')
subplot(313)
plot(ts,g_diff(6,:)*1e6, ts,-3*sqrt(P_cov(12,:))*1e6, ts,3*sqrt(P_cov(12,:))*1e6)
%plot(ts,3*sqrt(P_cov(12,:))*1e6)
axis([0 tf/3600 -300 300])
ylabel('\lambda_{z}, ppm')
xlabel('Time, hr')

%figure(25)
%subplot(311)
%plot(ts,g_diff(7,:)*1e6, ts,-3*sqrt(P_cov(13,:))*1e6, ts,3*sqrt(P_cov(13,:))*1e6)
%axis([0 tf/3600 -300 300])
%title('Gyro Asymmetric Scale Factor Error with 3\sigma bound')
%ylabel('\mu_{x}, ppm')
%subplot(312)
%plot(ts,g_diff(8,:)*1e6, ts,-3*sqrt(P_cov(14,:))*1e6, ts,3*sqrt(P_cov(14,:))*1e6)
%axis([0 tf/3600 -300 300])
%ylabel('\mu_{y}, ppm')
%subplot(313)
%plot(ts,g_diff(9,:)*1e6, ts,-3*sqrt(P_cov(15,:))*1e6, ts,3*sqrt(P_cov(15,:))*1e6)
%axis([0 tf/3600 -300 300])
%ylabel('\mu_{z}, ppm')
%xlabel('Time, hr')

figure(26)
subplot(311)
plot(ts,g_diff(1,:)*206264.8, ts,-3*sqrt(P_cov(7,:))*206264.8, ts,3*sqrt(P_cov(7,:))*206264.8)
%plot(ts,3*sqrt(P_cov(7,:))*206264.8)
axis([0 tf/3600 -300 300])
ylabel('\xi_{x}, arc-s')
title('Gyro Nonorthogonal Misalignments Error with 3\sigma bound')
subplot(312)
plot(ts,g_diff(2,:)*206264.8, ts,-3*sqrt(P_cov(8,:))*206264.8, ts,3*sqrt(P_cov(8,:))*206264.8)
%plot(ts,3*sqrt(P_cov(8,:))*206264.8)
axis([0 tf/3600 -300 300])
ylabel('\xi_{y}, arc-s')
subplot(313)
plot(ts,g_diff(3,:)*206264.8, ts,-3*sqrt(P_cov(9,:))*206264.8, ts,3*sqrt(P_cov(9,:))*206264.8)
%plot(ts,3*sqrt(P_cov(9,:))*206264.8)
axis([0 tf/3600 -300 300])
ylabel('\xi_{z}, arc-s')

figure(27)
subplot(311)
plot(ts,s1_diff(1,:)*60^2, ts,-3*sqrt(P_cov(13,:))*60^2, ts,3*sqrt(P_cov(13,:))*60^2)
%plot(ts,3*sqrt(P_cov(13,:))*60^2)
axis([0 tf/3600 -2.0 2.0])
title('Star Tracker Misalignments Error with 3\sigma bound')
ylabel('x, arc-s')
subplot(312)
plot(ts,s1_diff(2,:)*60^2, ts,-3*sqrt(P_cov(14,:))*60^2, ts,3*sqrt(P_cov(14,:))*60^2)
%plot(ts,3*sqrt(P_cov(14,:))*60^2)
axis([0 tf/3600 -2.0 2.0])
ylabel('y, arc-s')
subplot(313)
plot(ts,s1_diff(3,:)*60^2, ts,-3*sqrt(P_cov(15,:))*60^2, ts,3*sqrt(P_cov(15,:))*60^2)
%plot(ts,3*sqrt(P_cov(15,:))*60^2)
axis([0 tf/3600 -2.0 2.0])
ylabel('z, arc-s')
xlabel('Time, hr')

figure(28)
subplot(311)
plot(ts,p_diff(1,:)*60^2, ts,-3*sqrt(P_cov(16,:))*60^2, ts,3*sqrt(P_cov(16,:))*60^2)
%plot(ts,3*sqrt(P_cov(16,:))*60^2)
axis([0 tf/3600 -2.0 2.0])
title('Payload Misalignments Error with 3\sigma bound')
ylabel('x, arc-s')
subplot(312)
plot(ts,p_diff(2,:)*60^2, ts,-3*sqrt(P_cov(17,:))*60^2, ts,3*sqrt(P_cov(17,:))*60^2)
%plot(ts,3*sqrt(P_cov(17,:))*60^2)
axis([0 tf/3600 -2.0 2.0])
ylabel('y, arc-s')
subplot(313)
plot(ts,p_diff(3,:)*60^2, ts,-3*sqrt(P_cov(18,:))*60^2, ts,3*sqrt(P_cov(18,:))*60^2)
%plot(ts,3*sqrt(P_cov(18,:))*60^2)
axis([0 tf/3600 -2.0 2.0])
ylabel('z, arc-s')
xlabel('Time, hr')

figure(30)
subplot(211)
plot(ts,3*sqrt(P_cov(7,:))*206264.8,'-', ts,3*sqrt(P_cov(8,:))*206264.8,':', ts,3*sqrt(P_cov(9,:))*206264.8,'-.')
axis([0 tf/3600 0 300])
title('Gyro Nonorthogonal Misalignments with 3\sigma bound')
ylabel('arc-s')
xlabel('Time, hr')
legend('\xi_{x}','\xi_{y}','\xi_{z}')
subplot(212)
plot(ts,3*sqrt(P_cov(10,:))*1e6,'-', ts,3*sqrt(P_cov(11,:))*1e6,':', ts,3*sqrt(P_cov(12,:))*1e6,'-.')
axis([0 tf/3600 100 500])
title('Gyro Symmetric Scale Factor Error with 3\sigma bound')
ylabel('ppm')
xlabel('Time, hr')
legend('\lambda_{x}','\lambda_{y}','\lambda_{z}')

figure(31)
subplot(211)
plot(ts,3*sqrt(P_cov(13,:))*60^2,'-', ts,3*sqrt(P_cov(14,:))*60^2,':', ts,3*sqrt(P_cov(15,:))*60^2,'-.')
axis([0 tf/3600 0 2.0])
title('Star Tracker Misalignments with 3\sigma bound')
ylabel('arc-s')
xlabel('Time, hr')
legend('x','y','z')
subplot(212)
plot(ts,3*sqrt(P_cov(16,:))*60^2,'-', ts,3*sqrt(P_cov(17,:))*60^2,':', ts,3*sqrt(P_cov(18,:))*60^2,'-.')
axis([0 tf/3600 0 2.0])
title('Payload Misalignments with 3\sigma bound')
ylabel('arc-s')
xlabel('Time, hr')
legend('x','y','z')
